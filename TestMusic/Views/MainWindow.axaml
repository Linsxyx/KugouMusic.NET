<suki:SukiWindow xmlns="https://github.com/avaloniaui"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:vm="using:TestMusic.ViewModels"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:suki="https://github.com/kikipoulet/SukiUI"
                 xmlns:controls="clr-namespace:Avalonia.Labs.Controls;assembly=Avalonia.Labs.Controls"
                 xmlns:views="using:TestMusic.Views"
                 xmlns:controls1="clr-namespace:TestMusic.Controls"
                 mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
                 x:Class="TestMusic.Views.MainWindow"
                 x:DataType="vm:MainWindowViewModel"
                 Name="Root"
                 Icon="/Assets/avalonia-logo.ico"
                 Title="KuGou Avalonia Player"
                 BackgroundStyle="Bubble">

    <Grid RowDefinitions="Auto, *, Auto">
        
        <!-- 顶部搜索栏 (保持不变) -->
        <Grid Grid.Row="0" ColumnDefinitions="*, Auto, Auto" Margin="15">
            <TextBox Grid.Column="0" Text="{Binding SearchKeyword}" Watermark="搜索歌曲、歌手..." Theme="{StaticResource SukiTextBox}"/>
            <Button Grid.Column="1" Classes="Outlined" Command="{Binding SearchCommand}" Margin="10,0" Theme="{StaticResource SukiPrimaryButton}">
                <PathIcon Data="{x:Static suki:Icons.Search}" Margin="0,0,5,0"></PathIcon>
            </Button>
            <Button Grid.Column="2" Content="每日推荐" Command="{Binding GetDailyRecommendationsCommand}" Theme="{StaticResource SukiFlatButton}"/>
        </Grid>

        <!-- 中间内容区域 -->
        <Grid Grid.Row="1" ColumnDefinitions="250, *">
            <!-- 左侧：歌单列表 -->
            <suki:GlassCard Grid.Column="0" Margin="10,0,5,10">
                <Grid RowDefinitions="Auto, *">
                    <Button Grid.Row="0" Content="刷新我的歌单" Command="{Binding GetMyPlaylistsCommand}" HorizontalAlignment="Stretch" Margin="0,0,0,10"/>
                    <ListBox Grid.Row="1" ItemsSource="{Binding UserPlaylists}" Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="vm:PlaylistItem">
                                <StackPanel Spacing="5" Margin="0,5">
                                    <TextBlock Text="{Binding Name}" FontWeight="DemiBold"/>
                                    <Grid ColumnDefinitions="*, Auto">
                                        <TextBlock Text="{Binding Count, StringFormat='{}{0} 首'}" FontSize="12" Foreground="Gray"/>
                                        <Button Grid.Column="1" Classes="Basic" Width="25" Height="25" Padding="5,2"
                                                Command="{Binding #Root.((vm:MainWindowViewModel)DataContext).LoadPlaylistSongsCommand}"
                                                CommandParameter="{Binding Id}">
                                            <Svg Path="/Assets/plus-circle-svgrepo-com.svg" />
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </suki:GlassCard>

            <!-- 右侧：歌曲列表控件 -->
            <suki:GlassCard Grid.Column="1" Margin="5,0,10,10">
                <controls1:SongListControl/>
            </suki:GlassCard>
        </Grid>

        <!-- 底部播放栏 -->
        <suki:GlassCard Grid.Row="2" Margin="10,0,10,10" Padding="10">
            <Grid ColumnDefinitions="250, *, 200">
                
                <!-- 1. 左侧：当前歌曲信息 -->
                <Grid Grid.Column="0" ColumnDefinitions="Auto, *">
                    <Border CornerRadius="8" ClipToBounds="True" Width="60" Height="60">
                        <controls:AsyncImage Source="{Binding CurrentPlayingSong.Cover}" Stretch="UniformToFill"/>
                    </Border>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0">
                        <TextBlock Text="{Binding CurrentPlayingSong.Name, TargetNullValue='未播放'}" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="{Binding CurrentPlayingSong.Singer}" FontSize="12" Foreground="Gray" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>
                </Grid>

                <!-- 2. 中间：控制按钮 + 进度条 + 歌词 -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="5">
                    
                    <!-- 歌词展示 -->
                    <StackPanel HorizontalAlignment="Center" Height="40">
                         <TextBlock Text="{Binding CurrentLyricText}" HorizontalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource SukiPrimaryColor}"/>
                         <TextBlock Text="{Binding CurrentLyricTrans}" HorizontalAlignment="Center" FontSize="12" Foreground="Gray"/>
                    </StackPanel>

                    <!-- 控制按钮组 -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="20">
                        <Button Width="50" Height="50" Command="{Binding PlayPreviousCommand}" Classes="Basic" ToolTip.Tip="上一首">
                            <Svg Path="/Assets/backward-svgrepo-com.svg" />
                        </Button>

                        <!-- 播放/暂停 动态文本或图标 -->
                        <Button Command="{Binding TogglePlayPauseCommand}" Classes="Basic" Width="50" Height="50" CornerRadius="25">
                            <Button.Content>
                                <Panel>
                                    <Svg Path="/Assets/pause-svgrepo-com.svg" IsVisible="{Binding IsPlayingAudio}" />
                                    <Svg Path="/Assets/play-svgrepo-com.svg" IsVisible="{Binding !IsPlayingAudio}" />
                                </Panel>
                            </Button.Content>
                            
                        </Button>

                        <Button Width="50" Height="50" Command="{Binding PlayNextCommand}" Classes="Basic" ToolTip.Tip="下一首">
                            <Svg Path="/Assets/forward-svgrepo-com.svg" />
                        </Button>
                    </StackPanel>

                    <!-- 进度条 (Slider) -->
                    <Grid ColumnDefinitions="Auto, *, Auto" Margin="20,0">
                        <TextBlock Text="{Binding CurrentPositionSeconds,Converter={StaticResource SecondsToTimeConverter}}" FontSize="12" VerticalAlignment="Center"/>
                        
                        <!-- 绑定 CurrentPositionSeconds，ViewModel里有防抖逻辑 -->
                        <Slider Grid.Column="1" 
                                Minimum="0" 
                                Maximum="{Binding TotalDurationSeconds}" 
                                Value="{Binding CurrentPositionSeconds}"
                                Margin="10,0"
                                IsSnapToTickEnabled="False"/>
                                
                        <TextBlock Grid.Column="2" Text="{Binding TotalDurationSeconds,Converter={StaticResource SecondsToTimeConverter}}" FontSize="12" VerticalAlignment="Center"/>
                    </Grid>
                </StackPanel>

                <!-- 3. 右侧：音量与状态 -->
                <StackPanel Grid.Column="2" VerticalAlignment="Center" Spacing="5" Margin="10,0">
                    <Grid ColumnDefinitions="Auto, *">
                        <Svg Width="25" Height="25" Path="/Assets/volume-max-svgrepo-com.svg" Margin="0,0,5,0"/>
                        <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding MusicVolume}" Width="100"/>
                    </Grid>
                    <TextBlock Text="{Binding StatusMessage}" FontSize="10" Foreground="Gray" HorizontalAlignment="Right" TextTrimming="CharacterEllipsis"/>
                </StackPanel>
            </Grid>
        </suki:GlassCard>
    </Grid>
</suki:SukiWindow>